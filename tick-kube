#!/bin/bash

BP=$GOPATH/src/github.com/jackzampolin/tick-kube

# Name of cluster 
CLUSTER=influx-test-cluster

# Name of gcloud project
PROJECT=influx-perf-testing

# gcloud region
REGION=us-west1

# gcloud zone
ZONE=us-west1-b

# num GB of disk for nodes 
DISK=100

# gcloud instance types
MACHINE=n1-standard-1

# Number of nodes for kubernetes cluster
NUM_NODES=3

# InfluxDB Disk Size
INFLUX_DISK=25GB

# Chronograf and Kapacitor Disk Sizes
OTHER_DISK=10GB



kube () {
  kubectl apply -f $1
}

create-tick () {
  echo "Creating tick..."
  echo "tick is the full stack of InfluxData products running in production configuration"
  kube $BP/namespace.yaml
  kubectl create configmap --namespace tick telegraf-config --from-file $BP/telegraf/telegraf.conf
  kubectl create configmap --namespace tick influxdb-config --from-file $BP/influxdb/influxdb.conf
  kube $BP/influxdb/deployment.yaml
  kube $BP/influxdb/service.yaml
  kube $BP/kapacitor/deployment.yaml
  kube $BP/kapacitor/service.yaml
  kube $BP/telegraf/daemonset.yaml
  kube $BP/chronograf/deployment.yaml
  kube $BP/chronograf/service.yaml
  echo "Waiting for public IP..."
  kubectl get svc --namespace tick chronograf -w
}

create-disks () {
  echo "Creating persistent disks for the tick stack..."
  echo "InfluxDB Disk: $INFLUX_DISK"
  echo "Kapacitor Disk: $OTHER_DISK"
  echo "chronograf Disk: $OTHER_DISK"
  gcloud compute disks create chronograf kapacitor --size=$OTHER_DISK
  gcloud compute disks create influxdb --size=$INFLUX_DISK
}

delete-disks () {
  echo "Deleting disks for tick..."
  gcloud compute disks delete chronograf kapacitor influxdb
}

delete-tick () {
  kubectl delete ns tick
}

config-list () {
  project=$(gcloud config list project --format="value(core.project)" 2> /dev/null)
  zone=$(gcloud config list compute/zone --format="value(compute.zone)" 2> /dev/null)
  region=$(gcloud config list compute/region --format="value(compute.region)" 2> /dev/null)
  cluster=$(kubectl config current-context)
  cat <<-HERE
CURRENT CONFIG:
  project -> $project 
  zone    -> $zone 
  region  -> $region 
  cluster -> $cluster 
HERE
}

create-cluster () {
  echo "Creating a $NUM_NODES node cluster of $MACHINE VMs with $DISK GB size disks."
  gcloud container clusters create --disk-size $DISK --machine-type $MACHINE --num-nodes $NUM_NODES $CLUSTER 
  gcloud container clusters get-credentials $CLUSTER
}

delete-cluster () {
  gcloud container clusters delete $CLUSTER
}


config-set () {
  echo "Setting PROJECT to '$PROJECT'"
  nohup gcloud config set project $PROJECT > /dev/null
  echo "Setting ZONE to '$ZONE'"
  nohup gcloud config set compute/zone $ZONE > /dev/null
  echo "Setting REGION to '$REGION'"
  nohup gcloud config set compute/region $REGION > /dev/null
}

attach () {
  if [ -z $1 ]; 
    then echo "namespace not specified"; 
  else 
    echo "namespace: '$1'"; 
  fi
  if [ -z $2 ]; 
    then echo "app not specified"; 
  else 
    echo "app: '$2'"; 
  fi
  kubectl port-forward \
    --namespace $1 \
    $(kubectl get pods --namespace $1 -l app=$2 --output=jsonpath="{.items[0].metadata.name}") \
    $(kubectl get pods --namespace $1 -l app=$2 --output=jsonpath="{.items[0].spec.containers[0].ports[0].containerPort}")
}

update () {
  case $1 in
    chronograf)
      cd $GOPATH/src/github.com/influxdata/chronograf
      git pull origin master
      make docker
      docker tag chronograf gcr.io/$PROJECT/chronograf:latest
      gcloud docker push gcr.io/$PROJECT/chronograf:latest
      kubectl delete pod --namespace tick -l app=chronograf
      ;;
    influxdb)
      kubectl delete pods --namespace tick -l app=influxdb
      ;;
    telegraf)
      kubectl delete configmap --namespace tick telegraf-config
      kubectl create configmap --namespace tick telegraf-config --from-file $BP/telegraf/telegraf.conf 
      kubectl delete pod --namespace tick -l app=telegraf
      ;;
    kapacitor)
      kubectl delete pods --namespace tick -l app=kapacitor
      ;;
    *)
      cat <<-HERE
USAGE:
  $ tick-kube update {application}
  
OPTIONS:
  - chronograf - pulls new code, builds images, pushes and restarts podss
  - influxdb
  - telegraf - updates configmap and restarts pods
  - kapacitor
HERE
      exit 1
  esac
}

build-chronograf () {
  PROJECT=influx-perf-testing
  cd $GOPATH/src/github.com/influxdata/chronograf
  git pull origin master
  make docker
  docker tag chronograf gcr.io/$PROJECT/chronograf:latest
  gcloud docker push gcr.io/$PROJECT/chronograf:latest
}

usage () {
  cat <<-HERE
USAGE: $1
  attach
    - attaches to a pod port for given a namespace and app tag
    $ tick-kube attach tick influxdb
    
  build-chronograf
    - builds chronograf image from source and pushes it to gcloud docker'
    $ tick-kube build-chronograf
  
  create-cluster
    - creates cluster to run this example
    $ tick-kube create-cluster
  
  create-disks
    - creates all gcloud persistent disks for this application 
    $ tick-kube create-disks

  create-tick
    - creates all kube based resources for this application 
    $ tick-kube create-tick-kube
  
  config-list
    - lists current gcloud and kubectl context
    $ tick-kube config-list
  
  config-set
    - sets config to variables at top of file
    $ tick-kube config-set
  
  delete-disks
    - deletes the gcloud persistent disks for this application
    $ tick-kube delete-disks
      
  delete-cluster
    - deletes the gcloud cluster for this application
    $ tick-kube delete-cluster
      
  delete-tick
    - deletes the namespace and any other kube based resources for this application
    $ tick-kube delete
    
  spin-up
    - spins up a new cluster w/ all resources and provisions the full tick stack
    $ tick-kube spin-up
  
  spin-down
    - deletes the cluster and all associated resources
    $ tick-kube spin-down
    
  update {appliation}
    - performs a rolling update on the pods for this application 
    $ tick-kube update {application}
    - pass no args application list
    $ tick-kube update
HERE
}

create () {
  case $1 in
    tick)
      create-tick
      ;;
    cluster)
      create-cluster
      ;;
    disks)
      create-disks
      ;;
    *)
      usage
  esac
}

delete () {
  case $1 in
    tick)
      delete-tick
      ;;
    cluster)
      delete-cluster
      ;;
    disks)
      delete-disks
      ;;
    *)
      usage
  esac
}

config () {
  case $1 in 
    list)
      config-list
      ;;
    set)
      config-set
      ;;
  esac
}

case $1 in
  attach)
    attach $2 $3
    ;;
  create)
    create $2 $3
    ;;
  delete)
    delete $2 $3
    ;;
  config)
    config $2 $3
    ;;
  build-chronograf)
    build-chronograf
    ;;
  update)
    update $2 $3
    ;;
  spin-up)
    config-set
    create-cluster
    create-disks
    build-chronograf
    create-tick
    exit 0
    ;;
  spin-down)
    delete-tick
    delete-cluster
    delete-disks
    exit 0
    ;;
  *)
    usage
    exit 1
esac
